<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BK25 - Generate enterprise automation without enterprise complexity</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="BK25: Generate PowerShell, AppleScript, and Bash automation scripts using natural language. Agents for whomst? For humans who need automation that works.">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon.ico">
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BK25">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .chat-container {
            height: 400px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.user {
            background: #0d6efd;
            color: white;
            margin-left: auto;
        }
        
        .message.assistant {
            background: white;
            border: 1px solid #dee2e6;
        }
        
        .message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .script-output {
            background: #212529;
            color: #f8f9fa;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.connected {
            background: #198754;
        }
        
        .status-indicator.disconnected {
            background: #dc3545;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12 text-center text-white">
                <h1 class="display-3 fw-bold mb-2">ü§ñ BK25</h1>
                <p class="lead mb-1">Generate enterprise automation without enterprise complexity</p>
                <p class="text-white-50 fst-italic">"Agents for whomst?" - For humans who need automation that works.</p>
                <button class="btn btn-outline-light position-absolute top-0 end-0 m-3" id="settings-btn">
                    <i class="bi bi-gear"></i> Settings
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="row g-4">
            <!-- Chat Panel -->
            <div class="col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-light">
                        <span class="status-indicator" id="status-indicator"></span>
                        <strong>Conversation</strong>
                    </div>
                    
                    <div class="chat-container p-3" id="chat-container">
                        <!-- Initial greeting will be loaded dynamically from current persona -->
                    </div>
                    
                    <div class="card-footer">
                        <!-- Selectors Row -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="persona-select" class="form-label small fw-bold">Persona:</label>
                                <select class="form-select" id="persona-select">
                                    <option value="default">Loading...</option>
                                </select>
                                <button id="add-persona-btn" class="btn btn-sm btn-success mt-1">
                                    <i class="bi bi-plus"></i> Add Persona
                                </button>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="channel-select" class="form-label small fw-bold">Channel:</label>
                                <select class="form-select" id="channel-select">
                                    <option value="web">Loading...</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="platform-select" class="form-label small fw-bold">Platform:</label>
                                <select class="form-select" id="platform-select">
                                    <option value="powershell">PowerShell (Windows)</option>
                                    <option value="applescript">AppleScript (macOS)</option>
                                    <option value="bash">Bash (Linux/Unix)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Input Group -->
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="message-input" 
                                class="form-control" 
                                placeholder="What can I help you with today?"
                                autocomplete="off"
                            >
                            <button id="send-button" class="btn btn-primary">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                        
                        <!-- Examples -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="mb-2"><i class="bi bi-lightbulb"></i> Example requests:</h6>
                            <div class="example-item btn btn-sm btn-outline-secondary me-2 mb-1" data-text="What job do you need to get done?">What job do you need to get done?</div>
                            <div class="example-item btn btn-sm btn-outline-secondary me-2 mb-1" data-text="Tell me about the task you want to automate">Tell me about the task you want to automate</div>
                            <div class="example-item btn btn-sm btn-outline-secondary me-2 mb-1" data-text="I can help you generate code for your automation needs">I can help you generate code for your automation needs</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Output Panel -->
            <div class="col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-light">
                        <strong>Generated Script</strong>
                    </div>
                    
                    <div class="card-body" id="output-content">
                        <div class="text-center text-muted py-5">
                            <div class="display-1 mb-3">üìù</div>
                            <h5>Your generated automation scripts will appear here</h5>
                            <p class="text-muted">Start a conversation to generate your first script!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="row mt-5">
            <div class="col-12 text-center text-white-50">
                <p class="mb-0">
                    BK25 v1.0.0 - A love letter to the conversational AI community<br>
                    From Peter Swimm (original Botkit PM) and the Toilville team
                </p>
            </div>
        </div>
    </div>

    <!-- Add Persona Modal -->
    <div class="modal fade" id="add-persona-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Custom Persona</h5>
                    <button type="button" class="btn-close" id="close-modal"></button>
                </div>
                
                <form id="persona-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label" for="persona-name">Persona Name *</label>
                            <input type="text" id="persona-name" class="form-control" placeholder="e.g., Marketing Expert" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label" for="persona-description">Description</label>
                            <input type="text" id="persona-description" class="form-control" placeholder="Brief description of this persona">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label" for="persona-prompt">System Prompt Instructions *</label>
                            <textarea id="persona-prompt" class="form-control" rows="4" placeholder="You are a [role]. Your personality is [description]. Your approach is [method]. You should [guidelines]..." required></textarea>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancel-persona">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Persona</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settings-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">LLM Settings</h5>
                    <button type="button" class="btn-close" id="close-settings-modal"></button>
                </div>
                
                <form id="settings-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label" for="llm-provider">LLM Provider</label>
                            <select id="llm-provider" class="form-select">
                                <option value="ollama">Ollama (Local)</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="google">Google (Gemini)</option>
                                <option value="custom">Custom API</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="ollama-settings">
                            <label class="form-label" for="ollama-url">Ollama URL</label>
                            <input type="url" id="ollama-url" class="form-control" placeholder="http://localhost:11434" value="http://localhost:11434">
                            
                            <label class="form-label mt-2" for="ollama-model">Model Name</label>
                            <input type="text" id="ollama-model" class="form-control" placeholder="llama3.1:8b" value="llama3.1:8b">
                        </div>
                        
                        <div class="mb-3" id="openai-settings" style="display: none;">
                            <label class="form-label" for="openai-api-key">OpenAI API Key</label>
                            <input type="password" id="openai-api-key" class="form-control" placeholder="sk-...">
                            
                            <label class="form-label mt-2" for="openai-model">Model</label>
                            <select id="openai-model" class="form-select">
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="anthropic-settings" style="display: none;">
                            <label class="form-label" for="anthropic-api-key">Anthropic API Key</label>
                            <input type="password" id="anthropic-api-key" class="form-control" placeholder="sk-ant-...">
                            
                            <label class="form-label mt-2" for="anthropic-model">Model</label>
                            <select id="anthropic-model" class="form-select">
                                <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
                                <option value="claude-3-opus">Claude 3 Opus</option>
                                <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                <option value="claude-3-haiku">Claude 3 Haiku</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="google-settings" style="display: none;">
                            <label class="form-label" for="google-api-key">Google API Key</label>
                            <input type="password" id="google-api-key" class="form-control" placeholder="AIza...">
                            
                            <label class="form-label mt-2" for="google-model">Model</label>
                            <select id="google-model" class="form-select">
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                <option value="gemini-pro">Gemini Pro</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="custom-settings" style="display: none;">
                            <label class="form-label" for="custom-api-url">Custom API URL</label>
                            <input type="url" id="custom-api-url" class="form-control" placeholder="https://api.example.com/v1">
                            
                            <label class="form-label mt-2" for="custom-api-key">API Key</label>
                            <input type="password" id="custom-api-key" class="form-control" placeholder="Your API key">
                            
                            <label class="form-label mt-2" for="custom-model">Model Parameter</label>
                            <input type="text" id="custom-model" class="form-control" placeholder="model name or parameter">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label" for="temperature">Temperature</label>
                            <input type="range" id="temperature" class="form-range" min="0" max="2" step="0.1" value="0.7">
                            <div class="text-center text-muted small mt-1">
                                <span id="temperature-value">0.7</span> (0 = focused, 2 = creative)
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label" for="max-tokens">Max Tokens</label>
                            <input type="number" id="max-tokens" class="form-control" min="100" max="8000" value="2000">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label" for="timeout">Timeout (seconds)</label>
                            <input type="number" id="timeout" class="form-control" min="10" max="300" value="60">
                        </div>
                        
                        <div class="mb-3" id="connection-status" style="display: none;">
                            <div class="alert alert-info">
                                <span class="status-indicator" id="connection-indicator"></span>
                                <span id="connection-message">Testing connection...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancel-settings">Cancel</button>
                        <button type="button" class="btn btn-info" id="test-connection">Test Connection</button>
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // BK25 Web Interface
        class BK25Interface {
            constructor() {
                this.chatContainer = document.getElementById('chat-container');
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.platformSelect = document.getElementById('platform-select');
                this.personaSelect = document.getElementById('persona-select');
                this.channelSelect = document.getElementById('channel-select');
                this.addPersonaBtn = document.getElementById('add-persona-btn');
                this.outputContent = document.getElementById('output-content');
                this.statusIndicator = document.getElementById('status-indicator');
                
                this.isConnected = false;
                this.isLoading = false;
                this.currentPersona = null;
                this.currentChannel = null;
                
                this.init();
            }
            
            init() {
                // Event listeners
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Example click handlers
                document.querySelectorAll('.example-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.messageInput.value = item.dataset.text;
                        this.messageInput.focus();
                    });
                });
                
                // Persona change handler
                this.personaSelect.addEventListener('change', () => this.switchPersona());
                
                // Channel change handler
                this.channelSelect.addEventListener('change', () => this.switchChannel());
                
                // Add persona button handler
                this.addPersonaBtn.addEventListener('click', () => this.showAddPersonaModal());
                
                // Settings button handler
                document.getElementById('settings-btn').addEventListener('click', () => this.showSettingsModal());
                
                // Modal handlers
                this.setupModalHandlers();
                this.setupSettingsHandlers();
                
                // Load personas, channels and check server status
                this.loadPersonas();
                this.loadChannels();
                this.checkServerStatus();
                
                // Auto-focus input
                this.messageInput.focus();
            }
            
            async checkServerStatus() {
                try {
                    const response = await fetch('/health');
                    const data = await response.json();
                    
                    this.isConnected = response.ok && data.status === 'healthy';
                    this.updateStatusIndicator();
                    
                    if (!this.isConnected) {
                        this.addMessage('system', '‚ö†Ô∏è Server connection issue. Please check that BK25 is running.');
                    }
                } catch (error) {
                    this.isConnected = false;
                    this.updateStatusIndicator();
                    this.addMessage('system', '‚ùå Cannot connect to BK25 server. Please start the server.');
                }
            }
            
            updateStatusIndicator() {
                this.statusIndicator.className = `status-indicator ${this.isConnected ? 'connected' : 'disconnected'}`;
            }
            
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || this.isLoading) return;
                
                // Add user message
                this.addMessage('user', message);
                this.messageInput.value = '';
                
                // Show loading
                this.setLoading(true);
                
                try {
                                         const response = await fetch('/api/chat', {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json',
                         },
                         body: JSON.stringify({
                             message: message,
                             conversation_id: 'web_conversation',
                             persona_id: this.personaSelect.value,
                             channel_id: this.channelSelect.value,
                             context: {
                                 platform: this.platformSelect.value
                             }
                         })
                     });
                    
                    const data = await response.json();
                    
                    console.log('üîç Full response data:', data);
                    console.log('üîç Has extracted_code?', 'extracted_code' in data);
                    console.log('üîç extracted_code value:', data.extracted_code);
                    
                    if (response.ok) {
                        // Backend returns 'response' field, not 'message'
                        const responseText = data.response || data.message || 'No response received';
                        this.addMessage('assistant', responseText);
                        
                        // Check if we have persona info to update UI
                        if (data.persona) {
                            this.currentPersona = data.persona;
                            this.updatePersonaUI(data.persona);
                        }
                        
                                                 // Check if backend extracted code blocks for us
                         if (data.extracted_code && data.extracted_code.code) {
                             console.log('‚úÖ Backend extracted code:', data.extracted_code);
                             
                             // Display the extracted code in the script section
                             this.displayScript({
                                 filename: data.extracted_code.filename || 'Generated Script',
                                 platform: this.platformSelect.value,
                                 script: data.extracted_code.code,
                                 documentation: 'Generated by BK25',
                                 language: data.extracted_code.language
                             });
                         } else {
                             console.log('‚ÑπÔ∏è No code blocks extracted by backend');
                             console.log('üîç Response keys:', Object.keys(data));
                         }
                    } else {
                        this.addMessage('error', data.error || 'An error occurred');
                    }
                } catch (error) {
                    this.addMessage('error', 'Failed to connect to server: ' + error.message);
                } finally {
                    this.setLoading(false);
                }
            }
            
                         addMessage(type, content) {
                 const messageDiv = document.createElement('div');
                 messageDiv.className = `message ${type}`;
                 
                 // Simple message display - no complex parsing needed
                 messageDiv.innerHTML = content;
                 
                 this.chatContainer.appendChild(messageDiv);
                 this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
             }
            
            
            
            setLoading(loading) {
                this.isLoading = loading;
                this.sendButton.disabled = loading;
                
                if (loading) {
                    this.sendButton.innerHTML = '<div class="loading"></div>';
                } else {
                    this.sendButton.innerHTML = '<i class="bi bi-send"></i> Send';
                }
            }
            
            displayScript(automation) {
                console.log('üöÄ displayScript called!');
                console.log('Automation object:', automation);
                console.log('Script content:', automation.script);
                console.log('Script length:', automation.script ? automation.script.length : 'undefined');
                console.log('Script type:', typeof automation.script);
                console.log('Script preview:', automation.script ? automation.script.substring(0, 200) + '...' : 'undefined');
                
                // Create the script display using DOM methods instead of string interpolation
                const container = document.createElement('div');
                
                // Header with filename, language badge, and copy button
                const header = document.createElement('div');
                header.className = 'd-flex justify-content-between align-items-center mb-3';
                
                const headerLeft = document.createElement('div');
                headerLeft.className = 'd-flex align-items-center';
                
                const title = document.createElement('h5');
                title.className = 'mb-0 me-2';
                title.innerHTML = `üìÑ ${automation.filename || 'Generated Script'}`;
                
                const languageBadge = document.createElement('span');
                languageBadge.className = 'badge bg-secondary me-2';
                languageBadge.textContent = automation.language || 'script';
                
                const platformText = document.createElement('small');
                platformText.className = 'text-muted';
                platformText.textContent = `(${automation.platform})`;
                
                headerLeft.appendChild(title);
                headerLeft.appendChild(languageBadge);
                headerLeft.appendChild(platformText);
                
                // Copy button
                const copyBtn = document.createElement('button');
                copyBtn.className = 'btn btn-success btn-sm';
                copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy Script';
                copyBtn.onclick = () => this.copyScript(automation.script);
                
                header.appendChild(headerLeft);
                header.appendChild(copyBtn);
                
                                 // Script content
                 const scriptOutput = document.createElement('div');
                 scriptOutput.className = 'script-output p-3 rounded';
                 scriptOutput.style.cssText = 'background: #212529; color: #f8f9fa; font-family: "Courier New", monospace; white-space: pre-wrap; overflow-x: auto; border: 1px solid #495057;';
                 scriptOutput.textContent = automation.script;
                
                container.appendChild(header);
                container.appendChild(scriptOutput);
                
                // Documentation if present
                if (automation.documentation) {
                    const docDiv = document.createElement('div');
                    docDiv.className = 'mt-3 p-3 bg-light rounded border';
                    
                    const docTitle = document.createElement('h6');
                    docTitle.className = 'mb-2';
                    docTitle.textContent = 'üìã Documentation:';
                    
                    const docContent = document.createElement('div');
                    docContent.className = 'text-muted small';
                    docContent.style.whiteSpace = 'pre-line';
                    docContent.textContent = automation.documentation;
                    
                    docDiv.appendChild(docTitle);
                    docDiv.appendChild(docContent);
                    container.appendChild(docDiv);
                }
                
                                 // Clear and set the content
                 console.log('üßπ Clearing output content...');
                 this.outputContent.innerHTML = '';
                 console.log('üìù Appending script container...');
                 this.outputContent.appendChild(container);
                 console.log('‚úÖ Script displayed successfully');
                 console.log('Output content children count:', this.outputContent.children.length);
                 console.log('Output content HTML length:', this.outputContent.innerHTML.length);
            }
            

             
             escapeHtml(text) {
                 const div = document.createElement('div');
                 div.textContent = text;
                 return div.innerHTML;
             }
            
            copyScript(script) {
                navigator.clipboard.writeText(script).then(() => {
                    // Show feedback
                    const button = event.target;
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="bi bi-check"></i> Copied!';
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy script:', err);
                });
            }
            
            async loadPersonas() {
                try {
                    console.log('Loading personas...');
                    const response = await fetch('/api/personas?channel=web');
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Personas loaded:', data);
                        // Extract the personas array from the response
                        const personas = data.personas || [];
                        this.populatePersonaSelect(personas);
                        
                        // Load current persona
                        const currentResponse = await fetch('/api/personas/current');
                        if (currentResponse.ok) {
                            const currentPersona = await currentResponse.json();
                            console.log('Current persona:', currentPersona);
                            this.currentPersona = currentPersona;
                            this.updatePersonaUI(currentPersona);
                        } else {
                            console.error('Failed to load current persona:', currentResponse.status, currentResponse.statusText);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load personas:', error);
                }
            }
            
            populatePersonaSelect(personas) {
                console.log('Populating persona select with:', personas);
                this.personaSelect.innerHTML = '';
                personas.forEach(persona => {
                    const option = document.createElement('option');
                    option.value = persona.id;
                    option.textContent = persona.name;
                    this.personaSelect.appendChild(option);
                    console.log('Added persona option:', persona.name);
                });
            }
            
            async switchPersona() {
                const selectedPersonaId = this.personaSelect.value;
                if (!selectedPersonaId) return;
                
                try {
                    const response = await fetch(`/api/personas/${selectedPersonaId}/switch`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.currentPersona = data.persona;
                        this.updatePersonaUI(data.persona);
                        
                        // Clear chat and show new persona greeting
                        this.clearChat();
                        this.addMessage('assistant', data.persona.greeting);
                        this.updateExamples(data.persona.examples);
                    }
                } catch (error) {
                    console.error('Failed to switch persona:', error);
                }
            }
            
            updatePersonaUI(persona) {
                if (!persona) return;
                
                console.log('Updating persona UI with:', persona);
                
                // Update persona select
                this.personaSelect.value = persona.id;
                
                // Show persona greeting if chat is empty
                if (this.chatContainer.children.length === 0) {
                    const greeting = persona.greeting || `Hello! I'm ${persona.name}. How can I help you today?`;
                    console.log('Adding greeting:', greeting);
                    this.addMessage('assistant', greeting);
                    this.updateExamples(persona.examples || []);
                }
            }
            
            updateExamples(examples) {
                if (!examples || examples.length === 0) return;
                
                const exampleItems = document.querySelectorAll('.example-item');
                
                // Update existing examples with persona-specific ones
                examples.slice(0, 3).forEach((example, index) => {
                    if (exampleItems[index]) {
                        exampleItems[index].textContent = example;
                        exampleItems[index].dataset.text = example;
                    }
                });
            }
            
            clearChat() {
                this.chatContainer.innerHTML = '';
            }
            
            async loadChannels() {
                try {
                    console.log('Loading channels...');
                    const response = await fetch('/api/channels');
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Channels loaded:', data);
                        // Extract the channels array from the response
                        const channels = data.channels || [];
                        this.populateChannelSelect(channels);
                        
                        // Load current channel
                        const currentResponse = await fetch('/api/channels/current');
                        if (currentResponse.ok) {
                            const currentChannel = await currentResponse.json();
                            console.log('Current channel:', currentChannel);
                            this.currentChannel = currentChannel;
                            this.updateChannelUI(currentChannel);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load channels:', error);
                }
            }
            
            populateChannelSelect(channels) {
                console.log('Populating channel select with:', channels);
                this.channelSelect.innerHTML = '';
                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.id;
                    option.textContent = channel.name;
                    this.channelSelect.appendChild(option);
                    console.log('Added channel option:', channel.name);
                });
            }
            
            async switchChannel() {
                const selectedChannelId = this.channelSelect.value;
                if (!selectedChannelId) return;
                
                try {
                    const response = await fetch(`/api/channels/${selectedChannelId}/switch`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.currentChannel = data.channel;
                        this.updateChannelUI(data.channel);
                        
                        // Update examples based on channel capabilities
                        this.updateChannelExamples(data.channel, data.artifacts);
                    }
                } catch (error) {
                    console.error('Failed to switch channel:', error);
                }
            }
            
            updateChannelUI(channel) {
                if (!channel) return;
                this.channelSelect.value = channel.id;
            }
            
            updateChannelExamples(channel, artifacts) {
                if (!artifacts || artifacts.length === 0) return;
                
                const exampleItems = document.querySelectorAll('.example-item');
                
                // Update examples based on channel artifacts
                const channelExamples = [
                    `Create a ${channel.name} ${artifacts[0] || 'component'}`,
                    `Generate a ${artifacts[1] || 'workflow'} for ${channel.name}`,
                    `Build a ${artifacts[2] || 'interface'} for ${channel.name}`
                ];
                
                channelExamples.forEach((example, index) => {
                    if (exampleItems[index]) {
                        exampleItems[index].textContent = example;
                        exampleItems[index].dataset.text = example;
                    }
                });
            }
            
            showAddPersonaModal() {
                const modal = new bootstrap.Modal(document.getElementById('add-persona-modal'));
                modal.show();
            }
            
            hideAddPersonaModal() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('add-persona-modal'));
                modal.hide();
                
                // Clear form
                document.getElementById('persona-form').reset();
            }
            
            setupModalHandlers() {
                const closeBtn = document.getElementById('close-modal');
                const cancelBtn = document.getElementById('cancel-persona');
                const form = document.getElementById('persona-form');
                
                // Close modal handlers
                closeBtn.addEventListener('click', () => this.hideAddPersonaModal());
                cancelBtn.addEventListener('click', () => this.hideAddPersonaModal());
                
                // Form submission
                form.addEventListener('submit', (e) => this.handleCreatePersona(e));
            }
            
            async handleCreatePersona(e) {
                e.preventDefault();
                
                const name = document.getElementById('persona-name').value.trim();
                const description = document.getElementById('persona-description').value.trim();
                const systemPrompt = document.getElementById('persona-prompt').value.trim();
                
                if (!name || !systemPrompt) {
                    alert('Please fill in the required fields (Name and System Prompt)');
                    return;
                }
                
                try {
                    const response = await fetch('/api/personas/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            description: description,
                            systemPrompt: systemPrompt,
                            channels: ['web']
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Add new persona to dropdown
                        const option = document.createElement('option');
                        option.value = data.persona.id;
                        option.textContent = data.persona.name;
                        this.personaSelect.appendChild(option);
                        
                        // Switch to new persona
                        this.personaSelect.value = data.persona.id;
                        await this.switchPersona();
                        
                        // Hide modal
                        this.hideAddPersonaModal();
                        
                        // Show success message
                        this.addMessage('system', `‚úÖ Created custom persona: ${data.persona.name}`);
                        
                    } else {
                        const error = await response.json();
                        alert(`Failed to create persona: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Failed to create persona:', error);
                    alert('Failed to create persona. Please try again.');
                }
            }
            
            // Settings Modal Methods
            showSettingsModal() {
                const modal = new bootstrap.Modal(document.getElementById('settings-modal'));
                modal.show();
                this.loadCurrentSettings();
            }
            
            hideSettingsModal() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('settings-modal'));
                modal.hide();
            }
            
            setupSettingsHandlers() {
                const closeBtn = document.getElementById('close-settings-modal');
                const cancelBtn = document.getElementById('cancel-settings');
                const form = document.getElementById('settings-form');
                const providerSelect = document.getElementById('llm-provider');
                const testBtn = document.getElementById('test-connection');
                const temperatureSlider = document.getElementById('temperature');
                const temperatureValue = document.getElementById('temperature-value');
                
                // Close modal handlers
                closeBtn.addEventListener('click', () => this.hideSettingsModal());
                cancelBtn.addEventListener('click', () => this.hideSettingsModal());
                
                // Provider change handler
                providerSelect.addEventListener('change', () => this.toggleProviderSettings());
                
                // Temperature slider handler
                temperatureSlider.addEventListener('input', (e) => {
                    temperatureValue.textContent = e.target.value;
                });
                
                // Test connection handler
                testBtn.addEventListener('click', (e) => this.testConnection(e));
                
                // Form submission
                form.addEventListener('submit', (e) => this.handleSaveSettings(e));
            }
            
            toggleProviderSettings() {
                const provider = document.getElementById('llm-provider').value;
                const allSettings = ['ollama-settings', 'openai-settings', 'anthropic-settings', 'google-settings', 'custom-settings'];
                
                // Hide all settings
                allSettings.forEach(id => {
                    document.getElementById(id).style.display = 'none';
                });
                
                // Show selected provider settings
                if (provider !== 'ollama') {
                    document.getElementById(`${provider}-settings`).style.display = 'block';
                }
            }
            
            async loadCurrentSettings() {
                try {
                    const response = await fetch('/api/settings');
                    if (response.ok) {
                        const settings = await response.json();
                        this.populateSettingsForm(settings);
                    }
                } catch (error) {
                    console.error('Failed to load settings:', error);
                    // Load default settings
                    this.populateSettingsForm(this.getDefaultSettings());
                }
            }
            
            getDefaultSettings() {
                return {
                    provider: 'ollama',
                    ollama: {
                        url: 'http://localhost:11434',
                        model: 'llama3.1:8b'
                    },
                    openai: {
                        apiKey: '',
                        model: 'gpt-4o'
                    },
                    anthropic: {
                        apiKey: '',
                        model: 'claude-3-5-sonnet'
                    },
                    google: {
                        apiKey: '',
                        model: 'gemini-1.5-pro'
                    },
                    custom: {
                        url: '',
                        apiKey: '',
                        model: ''
                    },
                    temperature: 0.7,
                    maxTokens: 2000,
                    timeout: 60
                };
            }
            
            populateSettingsForm(settings) {
                document.getElementById('llm-provider').value = settings.provider || 'ollama';
                document.getElementById('ollama-url').value = settings.ollama?.url || 'http://localhost:11434';
                document.getElementById('ollama-model').value = settings.ollama?.model || 'llama3.1:8b';
                document.getElementById('openai-api-key').value = settings.openai?.apiKey || '';
                document.getElementById('openai-model').value = settings.openai?.model || 'gpt-4o';
                document.getElementById('anthropic-api-key').value = settings.anthropic?.apiKey || '';
                document.getElementById('anthropic-model').value = settings.anthropic?.model || 'claude-3-5-sonnet';
                document.getElementById('google-api-key').value = settings.google?.apiKey || '';
                document.getElementById('google-model').value = settings.google?.model || 'gemini-1.5-pro';
                document.getElementById('custom-api-url').value = settings.custom?.url || '';
                document.getElementById('custom-api-key').value = settings.custom?.apiKey || '';
                document.getElementById('custom-model').value = settings.custom?.model || '';
                document.getElementById('temperature').value = settings.temperature || 0.7;
                document.getElementById('temperature-value').textContent = settings.temperature || 0.7;
                document.getElementById('max-tokens').value = settings.maxTokens || 2000;
                document.getElementById('timeout').value = settings.timeout || 60;
                
                this.toggleProviderSettings();
            }
            
            async testConnection(e) {
                e.preventDefault();
                const testBtn = e.target;
                const originalText = testBtn.textContent;
                const statusDiv = document.getElementById('connection-status');
                const indicator = document.getElementById('connection-indicator');
                const message = document.getElementById('connection-message');
                
                // Show status
                statusDiv.style.display = 'block';
                testBtn.textContent = 'Testing...';
                testBtn.disabled = true;
                
                // Set initial status
                indicator.className = 'status-indicator';
                message.textContent = 'Testing connection...';
                
                try {
                    const settings = this.getSettingsFromForm();
                    const response = await fetch('/api/settings/test', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(settings)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        indicator.className = 'status-indicator connected';
                        message.textContent = `‚úÖ Connected! Model: ${result.model} (${result.responseTime}ms)`;
                        if (result.availableModels) {
                            message.textContent += ` | Available: ${result.availableModels.slice(0, 3).join(', ')}${result.availableModels.length > 3 ? '...' : ''}`;
                        }
                    } else {
                        indicator.className = 'status-indicator disconnected';
                        message.textContent = `‚ùå Connection failed: ${result.error || 'Unknown error'}`;
                    }
                } catch (error) {
                    indicator.className = 'status-indicator disconnected';
                    message.textContent = `‚ùå Test failed: ${error.message}`;
                } finally {
                    testBtn.textContent = originalText;
                    testBtn.disabled = false;
                }
            }
            
            getSettingsFromForm() {
                const provider = document.getElementById('llm-provider').value;
                
                return {
                    provider: provider,
                    ollama: {
                        url: document.getElementById('ollama-url').value,
                        model: document.getElementById('ollama-model').value
                    },
                    openai: {
                        apiKey: document.getElementById('openai-api-key').value,
                        model: document.getElementById('openai-model').value
                    },
                    anthropic: {
                        apiKey: document.getElementById('anthropic-api-key').value,
                        model: document.getElementById('anthropic-model').value
                    },
                    google: {
                        apiKey: document.getElementById('google-api-key').value,
                        model: document.getElementById('google-model').value
                    },
                    custom: {
                        url: document.getElementById('custom-api-url').value,
                        apiKey: document.getElementById('custom-api-key').value,
                        model: document.getElementById('custom-model').value
                    },
                    temperature: parseFloat(document.getElementById('temperature').value),
                    maxTokens: parseInt(document.getElementById('max-tokens').value),
                    timeout: parseInt(document.getElementById('timeout').value)
                };
            }
            
            async handleSaveSettings(e) {
                e.preventDefault();
                
                const settings = this.getSettingsFromForm();
                
                try {
                    const response = await fetch('/api/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(settings)
                    });
                    
                    if (response.ok) {
                        alert('‚úÖ Settings saved successfully!');
                        this.hideSettingsModal();
                        
                        // Refresh server status to check new connection
                        this.checkServerStatus();
                    } else {
                        const error = await response.json();
                        alert(`‚ùå Failed to save settings: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Failed to save settings:', error);
                    alert('Failed to save settings. Please try again.');
                }
            }
        }
        
        // Global function for copy button
        window.copyScript = function(script) {
            navigator.clipboard.writeText(script);
        };
        
        // Initialize the interface when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new BK25Interface();
        });
        
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
    
         <!-- Bootstrap 5 JavaScript -->
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
